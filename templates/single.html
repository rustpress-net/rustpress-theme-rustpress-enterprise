{% extends "templates/base.html" %}

{% block title %}{{ post.title }} - {{ site.name }}{% endblock %}

{% block meta %}
<meta name="description" content="{{ post.excerpt | striptags | truncate(length=160) }}">
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.excerpt | striptags | truncate(length=160) }}">
<meta property="og:type" content="article">
{% if post.featured_image %}
<meta property="og:image" content="{{ post.featured_image }}">
{% endif %}
<meta property="article:published_time" content="{{ post.date | date(format="Y-m-d") }}">
{% if post.author %}
<meta property="article:author" content="{{ post.author.name }}">
{% endif %}
{% endblock %}

{% block content %}
<main class="main-content">
  <!-- Post Header -->
  <header class="post-header">
    <div class="container">
      <div class="post-header-content" data-animate="fade-up">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <ol>
            <li><a href="/">Home</a></li>
            <li><a href="/blog">Blog</a></li>
            {% if post.category %}
            <li><a href="/category/{{ post.category.slug }}">{{ post.category.name }}</a></li>
            {% endif %}
            <li><span aria-current="page">{{ post.title | truncate(length=30) }}</span></li>
          </ol>
        </nav>

        <!-- Categories -->
        {% if post.categories %}
        <div class="post-categories">
          {% for category in post.categories %}
          <a href="/category/{{ category.slug }}" class="badge badge--rust">{{ category.name }}</a>
          {% endfor %}
        </div>
        {% endif %}

        <h1 class="post-title">{{ post.title }}</h1>

        {% if post.excerpt %}
        <p class="post-excerpt">{{ post.excerpt }}</p>
        {% endif %}

        <!-- Meta -->
        <div class="post-meta">
          {% if post.author %}
          <a href="/author/{{ post.author.slug }}" class="post-author">
            {% if post.author.avatar %}
            <img src="{{ post.author.avatar }}" alt="{{ post.author.name }}" class="post-author-avatar">
            {% else %}
            <div class="post-author-avatar post-author-avatar--placeholder">
              {{ post.author.name | first }}
            </div>
            {% endif %}
            <span class="post-author-name">{{ post.author.name }}</span>
          </a>
          {% endif %}

          <span class="post-meta-sep">·</span>

          <time datetime="{{ post.date | date(format="Y-m-d") }}" class="post-date">
            {{ post.date | date(format="F d, Y") }}
          </time>

          {% if post.reading_time %}
          <span class="post-meta-sep">·</span>
          <span class="post-reading-time">{{ post.reading_time }} min read</span>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <!-- Featured Image -->
  {% if post.featured_image %}
  <div class="post-featured-image" data-animate="fade-up" data-delay="100">
    <div class="container container--wide">
      <figure class="featured-image-figure">
        <img src="{{ post.featured_image }}" alt="{{ post.featured_image_alt | default(value=post.title) }}">
        {% if post.featured_image_caption %}
        <figcaption>{{ post.featured_image_caption }}</figcaption>
        {% endif %}
      </figure>
    </div>
  </div>
  {% endif %}

  <!-- Post Content -->
  <section class="post-content-section section">
    <div class="container">
      <div class="post-layout">
        <!-- Sidebar (Table of Contents) -->
        <aside class="post-sidebar">
          <div class="post-toc" id="table-of-contents">
            <h4 class="toc-title">Table of Contents</h4>
            <nav class="toc-nav" id="toc-nav">
              <!-- Generated by JS -->
            </nav>
          </div>

          <!-- Share Buttons -->
          <div class="post-share">
            <h4 class="share-title">Share this post</h4>
            <div class="share-buttons">
              <a href="https://twitter.com/intent/tweet?url={{ post.url | urlencode }}&text={{ post.title | urlencode }}" target="_blank" rel="noopener" class="share-btn share-btn--twitter" aria-label="Share on Twitter">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </a>
              <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ post.url | urlencode }}&title={{ post.title | urlencode }}" target="_blank" rel="noopener" class="share-btn share-btn--linkedin" aria-label="Share on LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
              </a>
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ post.url | urlencode }}" target="_blank" rel="noopener" class="share-btn share-btn--facebook" aria-label="Share on Facebook">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              </a>
              <button class="share-btn share-btn--copy" data-url="{{ post.url }}" aria-label="Copy link">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
              </button>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <article class="post-article">
          <div class="post-content prose" data-animate="fade-up">
            {{ post.content | safe }}
          </div>

          <!-- Tags -->
          {% if post.tags %}
          <div class="post-tags">
            <span class="tags-label">Tags:</span>
            {% for tag in post.tags %}
            <a href="/tag/{{ tag.slug }}" class="tag">{{ tag.name }}</a>
            {% endfor %}
          </div>
          {% endif %}

          <!-- Author Box -->
          {% if post.author %}
          <div class="author-box" data-animate="fade-up">
            {% if post.author.avatar %}
            <img src="{{ post.author.avatar }}" alt="{{ post.author.name }}" class="author-box-avatar">
            {% else %}
            <div class="author-box-avatar author-box-avatar--placeholder">
              {{ post.author.name | first }}
            </div>
            {% endif %}
            <div class="author-box-info">
              <h4 class="author-box-name">{{ post.author.name }}</h4>
              {% if post.author.bio %}
              <p class="author-box-bio">{{ post.author.bio }}</p>
              {% endif %}
              {% if post.author.social %}
              <div class="author-box-social">
                {% if post.author.social.twitter %}
                <a href="{{ post.author.social.twitter }}" target="_blank" rel="noopener">Twitter</a>
                {% endif %}
                {% if post.author.social.github %}
                <a href="{{ post.author.social.github }}" target="_blank" rel="noopener">GitHub</a>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </article>
      </div>
    </div>
  </section>

  <!-- Related Posts -->
  {% if related_posts %}
  <section class="related-posts-section section section--muted">
    <div class="container">
      <h2 class="section-title" data-animate="fade-up">Related Posts</h2>
      <div class="related-posts-grid" data-animate-stagger>
        {% for related in related_posts | slice(end=3) %}
        <article class="related-post-card">
          {% if related.featured_image %}
          <a href="{{ related.url }}" class="related-post-image">
            <img src="{{ related.featured_image }}" alt="{{ related.title }}">
          </a>
          {% endif %}
          <div class="related-post-content">
            <h3><a href="{{ related.url }}">{{ related.title }}</a></h3>
            <time datetime="{{ related.date | date(format="Y-m-d") }}">{{ related.date | date(format="M d, Y") }}</time>
          </div>
        </article>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Comments Section -->
  {% if site.comments_enabled %}
  <section class="comments-section section">
    <div class="container">
      <div class="comments-container">
        <h2 class="section-title" data-animate="fade-up">Comments</h2>
        <div id="comments">
          <!-- Comments loaded here -->
        </div>
      </div>
    </div>
  </section>
  {% endif %}
</main>
{% endblock %}

{% block scripts %}
<script>
// Generate Table of Contents
document.addEventListener('DOMContentLoaded', function() {
  const content = document.querySelector('.post-content');
  const tocNav = document.getElementById('toc-nav');

  if (!content || !tocNav) return;

  const headings = content.querySelectorAll('h2, h3');
  if (headings.length < 2) {
    document.getElementById('table-of-contents').style.display = 'none';
    return;
  }

  const toc = document.createElement('ul');

  headings.forEach((heading, index) => {
    // Add ID to heading
    const id = heading.id || 'heading-' + index;
    heading.id = id;

    // Create TOC item
    const li = document.createElement('li');
    li.className = 'toc-item toc-item--' + heading.tagName.toLowerCase();

    const a = document.createElement('a');
    a.href = '#' + id;
    a.textContent = heading.textContent;
    a.addEventListener('click', function(e) {
      e.preventDefault();
      heading.scrollIntoView({ behavior: 'smooth' });
    });

    li.appendChild(a);
    toc.appendChild(li);
  });

  tocNav.appendChild(toc);

  // Highlight current section
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const id = entry.target.id;
      const tocLink = tocNav.querySelector('a[href="#' + id + '"]');
      if (tocLink) {
        if (entry.isIntersecting) {
          tocNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
          tocLink.classList.add('active');
        }
      }
    });
  }, { rootMargin: '0px 0px -80% 0px' });

  headings.forEach(h => observer.observe(h));
});

// Copy link button
document.querySelectorAll('.share-btn--copy').forEach(btn => {
  btn.addEventListener('click', async function() {
    const url = this.dataset.url || window.location.href;
    try {
      await navigator.clipboard.writeText(url);
      this.classList.add('copied');
      setTimeout(() => this.classList.remove('copied'), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  });
});
</script>
{% endblock %}

{% block styles %}
<style>
.post-header {
  padding: var(--space-16) 0 var(--space-10);
  background: var(--gradient-dark);
}

.post-header-content {
  max-width: 800px;
  margin: 0 auto;
  text-align: center;
}

.breadcrumbs {
  margin-bottom: var(--space-6);
}

.breadcrumbs ol {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: var(--space-2);
  font-size: var(--text-sm);
  color: var(--color-text-muted);
}

.breadcrumbs li::after {
  content: '/';
  margin-left: var(--space-2);
}

.breadcrumbs li:last-child::after {
  display: none;
}

.breadcrumbs a:hover {
  color: var(--color-rust-light);
}

.post-categories {
  display: flex;
  justify-content: center;
  gap: var(--space-2);
  margin-bottom: var(--space-4);
}

.post-title {
  font-size: var(--text-4xl);
  font-weight: var(--weight-bold);
  line-height: var(--leading-tight);
  margin-bottom: var(--space-4);
}

.post-excerpt {
  font-size: var(--text-xl);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-6);
}

.post-meta {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-3);
  font-size: var(--text-sm);
  color: var(--color-text-muted);
}

.post-author {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.post-author-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}

.post-author-avatar--placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gradient-rust);
  color: white;
  font-weight: var(--weight-semibold);
}

.post-author-name {
  color: var(--color-text-primary);
  font-weight: var(--weight-medium);
}

.post-featured-image {
  margin-top: calc(-1 * var(--space-6));
  margin-bottom: var(--space-12);
}

.featured-image-figure {
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: var(--shadow-2xl);
}

.featured-image-figure img {
  width: 100%;
  height: auto;
  max-height: 500px;
  object-fit: cover;
}

.featured-image-figure figcaption {
  padding: var(--space-3);
  background: var(--color-bg-secondary);
  font-size: var(--text-sm);
  color: var(--color-text-muted);
  text-align: center;
}

.post-layout {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: var(--space-12);
}

.post-sidebar {
  position: sticky;
  top: 100px;
  height: fit-content;
}

.post-toc {
  background: var(--color-bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  margin-bottom: var(--space-6);
}

.toc-title, .share-title {
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wider);
  color: var(--color-text-muted);
  margin-bottom: var(--space-4);
}

.toc-nav ul {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.toc-item a {
  display: block;
  padding: var(--space-2);
  font-size: var(--text-sm);
  color: var(--color-text-secondary);
  border-radius: var(--radius-md);
  transition: all var(--duration-fast) var(--ease-out);
}

.toc-item--h3 a {
  padding-left: var(--space-6);
  font-size: var(--text-xs);
}

.toc-item a:hover,
.toc-item a.active {
  color: var(--color-rust-light);
  background: rgba(206, 66, 43, 0.1);
}

.post-share {
  background: var(--color-bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
}

.share-buttons {
  display: flex;
  gap: var(--space-2);
}

.share-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-md);
  background: var(--color-bg-tertiary);
  color: var(--color-text-secondary);
  transition: all var(--duration-fast) var(--ease-out);
}

.share-btn:hover {
  color: white;
}

.share-btn--twitter:hover { background: #1DA1F2; }
.share-btn--linkedin:hover { background: #0A66C2; }
.share-btn--facebook:hover { background: #1877F2; }
.share-btn--copy:hover { background: var(--color-rust); }
.share-btn--copy.copied { background: var(--color-success); }

.post-article {
  max-width: 720px;
}

.post-content {
  font-size: var(--text-lg);
  line-height: var(--leading-relaxed);
}

.post-tags {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  align-items: center;
  padding-top: var(--space-8);
  margin-top: var(--space-8);
  border-top: 1px solid var(--border-color);
}

.tags-label {
  font-size: var(--text-sm);
  color: var(--color-text-muted);
  font-weight: var(--weight-medium);
}

.author-box {
  display: flex;
  gap: var(--space-6);
  padding: var(--space-8);
  background: var(--color-bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  margin-top: var(--space-10);
}

.author-box-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.author-box-avatar--placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gradient-rust);
  color: white;
  font-size: var(--text-2xl);
  font-weight: var(--weight-bold);
}

.author-box-name {
  font-size: var(--text-lg);
  font-weight: var(--weight-semibold);
  margin-bottom: var(--space-2);
}

.author-box-bio {
  font-size: var(--text-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-3);
}

.author-box-social {
  display: flex;
  gap: var(--space-4);
}

.author-box-social a {
  font-size: var(--text-sm);
  color: var(--color-rust-light);
}

.related-posts-section {
  background: var(--color-bg-secondary);
}

.related-posts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-6);
}

.related-post-card {
  background: var(--color-bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  overflow: hidden;
  transition: transform var(--duration-normal) var(--ease-out);
}

.related-post-card:hover {
  transform: translateY(-4px);
}

.related-post-image img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}

.related-post-content {
  padding: var(--space-5);
}

.related-post-content h3 {
  font-size: var(--text-base);
  font-weight: var(--weight-semibold);
  margin-bottom: var(--space-2);
  line-height: var(--leading-snug);
}

.related-post-content h3 a:hover {
  color: var(--color-rust-light);
}

.related-post-content time {
  font-size: var(--text-xs);
  color: var(--color-text-muted);
}

.comments-container {
  max-width: 720px;
  margin: 0 auto;
}

@media (max-width: 1024px) {
  .post-layout {
    grid-template-columns: 1fr;
  }

  .post-sidebar {
    display: none;
  }

  .related-posts-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .post-header {
    padding: var(--space-12) 0 var(--space-8);
  }

  .post-title {
    font-size: var(--text-2xl);
  }

  .post-meta {
    flex-wrap: wrap;
  }

  .author-box {
    flex-direction: column;
    text-align: center;
  }

  .author-box-avatar {
    margin: 0 auto;
  }

  .author-box-social {
    justify-content: center;
  }
}
</style>
{% endblock %}
