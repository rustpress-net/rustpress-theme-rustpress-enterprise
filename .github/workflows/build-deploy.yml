name: Build and Deploy

on:
  push:
    branches: [main, without-rustpress]
  pull_request:
    branches: [main, without-rustpress]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create a release'
        required: false
        default: false
        type: boolean
      release_tag:
        description: 'Release tag (e.g., v2.0.1)'
        required: false
        type: string

env:
  THEME_NAME: rustpress-theme-enterprise

jobs:
  # Detect branch type and set build configuration
  detect-type:
    name: Detect Build Type
    runs-on: ubuntu-latest
    outputs:
      is_static: ${{ steps.detect.outputs.is_static }}
      build_dir: ${{ steps.detect.outputs.build_dir }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect branch type
        id: detect
        run: |
          # Check if this is the static branch (no templates folder)
          if [ -f "index.html" ] && [ ! -d "templates" ]; then
            echo "is_static=true" >> $GITHUB_OUTPUT
            echo "build_dir=." >> $GITHUB_OUTPUT
            echo "Detected: Static HTML site"
          else
            echo "is_static=false" >> $GITHUB_OUTPUT
            echo "build_dir=dist" >> $GITHUB_OUTPUT
            echo "Detected: Template-based site"
          fi

          # Get version from theme.json
          VERSION=$(jq -r '.version' theme.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # Validate theme structure
  validate:
    name: Validate Theme
    runs-on: ubuntu-latest
    needs: detect-type
    steps:
      - uses: actions/checkout@v4

      - name: Validate theme.json
        run: |
          if [ ! -f "theme.json" ]; then
            echo "Error: theme.json not found"
            exit 1
          fi
          jq empty theme.json || (echo "Error: Invalid JSON in theme.json" && exit 1)
          echo "✓ theme.json is valid"

      - name: Check assets structure
        run: |
          echo "Checking assets..."
          if [ -d "assets/css" ]; then
            echo "✓ assets/css/ exists"
            ls -la assets/css/
          else
            echo "✗ assets/css/ not found"
            exit 1
          fi

          if [ -d "assets/js" ]; then
            echo "✓ assets/js/ exists"
            ls -la assets/js/
          else
            echo "✗ assets/js/ not found"
            exit 1
          fi

      - name: Validate HTML files (static branch)
        if: needs.detect-type.outputs.is_static == 'true'
        run: |
          echo "Checking HTML files..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            fi
          done

      - name: Validate templates (main branch)
        if: needs.detect-type.outputs.is_static == 'false'
        run: |
          echo "Checking templates..."
          if [ -d "templates" ]; then
            echo "✓ templates/ exists"
            find templates -name "*.html" | head -20
          else
            echo "✗ templates/ not found"
            exit 1
          fi

  # Build the theme
  build:
    name: Build Theme
    runs-on: ubuntu-latest
    needs: [detect-type, validate]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build static site
        if: needs.detect-type.outputs.is_static == 'true'
        run: |
          echo "Building static site..."
          mkdir -p dist

          # Copy all HTML files
          cp *.html dist/ 2>/dev/null || true

          # Copy assets
          cp -r assets dist/

          # Copy other necessary files
          cp theme.json dist/ 2>/dev/null || true
          cp LICENSE dist/ 2>/dev/null || true

          echo "Build complete!"
          ls -la dist/

      - name: Build template site
        if: needs.detect-type.outputs.is_static == 'false'
        run: |
          echo "Building template-based site..."
          mkdir -p dist

          # For template sites, we need to generate static HTML
          # This uses a simple approach - copy templates and process them

          # Copy assets
          cp -r assets dist/

          # Copy templates for reference
          cp -r templates dist/

          # Copy theme config
          cp theme.json dist/
          cp LICENSE dist/ 2>/dev/null || true

          echo "Build complete!"
          ls -la dist/

      - name: Create deployment artifact
        run: |
          cd dist
          zip -r ../${{ env.THEME_NAME }}.zip .
          cd ..
          echo "Created ${{ env.THEME_NAME }}.zip"
          ls -la *.zip

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: theme-build
          path: dist/
          retention-days: 7

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: theme-zip
          path: ${{ env.THEME_NAME }}.zip
          retention-days: 7

  # Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [detect-type, build]
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/without-rustpress')) ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy == true)
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: theme-build
          path: dist/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Create release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [detect-type, build]
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.create_release == true) ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[release]'))
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: theme-zip
          path: ./

      - name: Determine release tag
        id: tag
        run: |
          if [ -n "${{ inputs.release_tag }}" ]; then
            TAG="${{ inputs.release_tag }}"
          else
            VERSION=$(jq -r '.version' theme.json)
            TAG="v${VERSION}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Get theme info
        id: theme
        run: |
          THEME_NAME=$(jq -r '.name' theme.json)
          DESCRIPTION=$(jq -r '.description' theme.json)
          echo "name=$THEME_NAME" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" ${LAST_TAG}..HEAD | head -50)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" -20)
          fi

          # Determine if static or template build
          if [ -f "index.html" ] && [ ! -d "templates" ]; then
            BUILD_TYPE="Static HTML"
          else
            BUILD_TYPE="Template-based"
          fi

          cat > RELEASE_NOTES.md << EOF
          ## ${{ steps.theme.outputs.name }} ${{ steps.tag.outputs.tag }}

          ${{ steps.theme.outputs.description }}

          ### Build Type
          ${BUILD_TYPE}

          ### Changes
          ${CHANGES}

          ### Installation
          1. Download the zip file
          2. Extract to your themes directory
          3. Activate the theme

          ### For Static Version
          Simply extract and open \`index.html\` in your browser, or deploy to any static hosting.
          EOF

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.theme.outputs.name }} ${{ steps.tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ env.THEME_NAME }}.zip
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag, 'beta') || contains(steps.tag.outputs.tag, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
